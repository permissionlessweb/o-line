---
version: "2.0"
services:
  ${SNAPSHOT_SVC}:
    image: ${OMNIBUS_IMAGE}
    expose:
      - port: 26656
        as: 26656
        to:
          - global: true
      - port: 26657
        as: 26657
        to:
          - global: true
        accept:
          - statesync.terp.network # ‚Üê only for RPC, not P2P
    env:
      - MONIKER=${SNAPSHOT_MONIKER}
      - CHAIN_JSON=${CHAIN_JSON}
      - MINIMUM_GAS_PRICES=0.05uthiol
      - FASTSYNC_VERSION=v0
      # keep full state for statesync serving
      - PRUNING=nothing
      - STATESYNC_SNAPSHOT_INTERVAL=500
      - COSMOVISOR_ENABLED=1
      # peer exchange disabled
      - TERPD_P2P_PEX=false
      # public address book & snapshot
      - ADDRBOOK_URL=${ADDRBOOK_URL}
      - SNAPSHOT_URL=${SNAPSHOT_URL}
      - SNAPSHOT_FORMAT=tar.lz4
      - TERPD_P2P_PRIVATE_PEER_IDS=${TERPD_P2P_PRIVATE_PEER_IDS}
      - WASMVM_PATH=/lib/libwasmvm.x86_64.so
      - WASMVM_VERSION=v3.0.2
      - WASMVM_URL=https://github.com/CosmWasm/wasmvm/releases/download/v3.0.2/libwasmvm.x86_64.so
      # s3 snapshot export
      - S3_KEY=${S3_KEY}
      - S3_SECRET=${S3_SECRET}
      - S3_HOST=${S3_HOST}
      - SNAPSHOT_PATH=${SNAPSHOT_PATH}
      - SNAPSHOT_TIME=${SNAPSHOT_TIME}
      - SNAPSHOT_DIR=/root/.terp
      - SNAPSHOT_METADATA=1
      - SNAPSHOT_METADATA_URL=${SNAPSHOT_METADATA_URL}
      - SNAPSHOT_SAVE_FORMAT=${SNAPSHOT_SAVE_FORMAT}
      - SNAPSHOT_RETAIN=${SNAPSHOT_RETAIN}
      - SNAPSHOT_KEEP_LAST=${SNAPSHOT_KEEP_LAST}
      - SNAPSHOT_ON_START=1
  ${SEED_SVC}:
    image: ${OMNIBUS_IMAGE}
    expose:
      - port: 26657
        as: 26657
        accept:
          - statesync-b.terp.network
          - www.statesync-b.terp.network
        to:
          - global: true
      # DNS for <id>@seed.terp.network:26656
      - port: 26656
        as: 26656
        accept:
          - seed.terp.network
          - www.seed.terp.network
        to:
          - global: true
    env:
      - MONIKER=${SEED_MONIKER}
      # default chain cfg
      - CHAIN_JSON=${CHAIN_JSON}
      - MINIMUM_GAS_PRICES=0.05uthiol
      - PRUNING=default
      # peer exchange enabled
      - TERPD_P2P_PEX=true
      # public address book & snapshot
      - SNAPSHOT_URL=${SNAPSHOT_URL}
      - SNAPSHOT_FORMAT=tar.lz4
      - FASTSYNC_VERSION=v0
      - STATESYNC_SNAPSHOT_INTERVAL=500
      # - COSMOVISOR_ENABLED=1
      - WASMVM_PATH=/lib/libwasmvm.x86_64.so
      - WASMVM_VERSION=v3.0.2
      - WASMVM_URL=https://github.com/CosmWasm/wasmvm/releases/download/v3.0.2/libwasmvm.x86_64.so
      # - STATESYNC_RPC_SERVERS=<mainnet-terp-rpc.konsortech.xyz:443,rpc.terp.aknodes.net:443>
      - ADDRBOOK_URL=${ADDRBOOK_URL}
profiles:
  compute:
    ${SNAPSHOT_SVC}:
      resources:
        cpu:
          units: 4
        memory:
          size: 16Gi
        storage:
          - size: 250Gi
    ${SEED_SVC}:
      resources:
        cpu:
          units: 2
        memory:
          size: 8Gi
        storage:
          - size: 50Gi
  placement:
    dcloud:
      pricing:
        ${SNAPSHOT_SVC}:
          denom: uakt
          amount: 1000
        ${SEED_SVC}:
          denom: uakt
          amount: 1000
      signedBy:
        anyOf:
          - akash1365yvmc4s7awdyj3n2sav7xfx76adc6dnmlx63
      attributes:
        host: akash
deployment:
  ${SNAPSHOT_SVC}:
    dcloud:
      profile: ${SNAPSHOT_SVC}
      count: 1
  ${SEED_SVC}:
    dcloud:
      profile: ${SEED_SVC}
      count: 1
